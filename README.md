# Threshold setting and analysis of ddPCR data

What is it?
-
This is a simplified and user friendly algorithm for consistent threshold setting and analysis of ddPCR data based on the [cloudy v3.07 algorithm](https://github.com/Gromgorgel/ddPCR/blob/master/Cloudy-V3-07.R) of Aanton Lievens.

Requirements
-
Software: 
- R (and RStudio) to run the analysis algorithm
- Quantasoft or QX Manager to generate raw amplitude data of ddPCR readout

How does it work?
-
The algorithm starts by running a single line of code in RStudio that can be copied from:
- [here](https://github.com/kamitoth/ddPCR-threshold-setting-/blob/main/call_cloudy_batch_process_function_v1_3.R)   
or here:
```
suppressPackageStartupMessages(source("https://raw.githubusercontent.com/kamitoth/ddPCR-threshold-setting-/main/cloudy_batch_process_function_v1_3.R", encoding="latin1"))
```
Run the code in RStudio!
#### It requires to select the folder where the amplitude data are saved and five questions need to be answered in the RSudio console!  
*Please note that the amplitude data folder must contain only csv files that were generated by the droplet reader. Please, delete empty (failed readout) files before running the script. For more information about data requirements: https://github.com/Gromgorgel/ddPCR*

#### What are the questions?
1) Which channel?
   - Select the detection channel from the options (currently either 1 or 2)
2) Which well (default = all)?
   - Select the single well that you want to analyse (e.g. B05) or leave it blank to analyse the entire plate.
3) What is the droplet volume (nL; default = 0.797 nL)?
   - Specify the droplet volume in nL. The default option is 0.797 nL that was experimentally determined for the 'One Step RT PCR Mix'.  
   Other frequent possibilities are:
   - 0.771 nL determined for regular PCR Mix without DUTP
   - 0.834 nL is used for regular PCR Mix (with DUTP)
   - The Biorad default for ALL of their mastermixes is 0.795 nL (as of 07/02/2024)
4) What is the sample volume (µL; default = 5 µL)?
   - Specify the sample volume per well in µL. The default option is 5 µL.
5) What is the dilution factor?
   - Specify the dilution factor. It allows the calculation of the original sample concentration but it is only useful if all of the samples have the same dilution factor.

What kind of digital PCR data can be used and analysed?
-
The script can read and analyse raw amplitude data generated by either the Biorad QX200 or QX600 droplet readers and either by Quantasoft or QX Manager software.  
*Please note that currently the script only works with the first two channels of the QX600!*

How is the threshold set?
-
The threshold is set slightly above the negative cloud for each individual well. It is set independently of any NTC but consistently and reproducibly, using the same algorithm.  
The algorithm is the cloudy v3.07 that was developed by Aanton Lievens. A limited feature version was created to make the analysis simpler and more user-friendly.  
More information about the threshold settings can be found in his [publication](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0153317) and [github page](https://github.com/Gromgorgel/ddPCR):

Output
-
The function output is 1) a table in RStudio and 2) a resultsChx.xlsx (where x= 1 or 2) file with the following components:
- `targets.in.sVol`, a numerical vector of length three containing the estimated number of targets in the sample volume (`targ.in.sVol`) and its Poisson confidence bounds (`upper`, `lower`).
- `lambda`, a numerical vector of length three containing the estimated average number of targets per compartment (`lambda`) and its Poisson confidence bounds (`upper`, `lower`).
- `performance`, a numerical vector of length three containing the performance paramters calculated from the input data: `resolution`, ratio of rain to total compartments (`%rain`), and the degree of compartmentalization (`%comparted`)
- `droplets`, a numerical vector of length three containing the number of compartments counted in each category (`positive`, `negative`, `accepted` & `rain`).
- `populations`, a numerical of length 1, the number of fluorescence populations as detected by the algorithm 
- `threshold`, a numerical of length 1, the fluorescence value used as threshold
- copy number concentrations a) in the diluted sample (`ccp_diluted_sample`) b) in the PCR solution (`ccp_pcr_solution`) and c) in the original sample if the dilution factor is given (`ccp_per_unit`)

Some of these components are automatically copied into the clipboard and with Ctrl+V can be pasted into a form or empty excel sheet. These components are: well (plate location), threshold level, positive, negative and total analysed partitions. 

Warning
-
The algorithm might fail to set the threshold correctly if...
- the data quality is poor (e.g. there are many different populations or the separation between positive and positive droplets is inadequate)
- there are very few positive or negative droplets
In these situations, it is recommended to manually overwrite the threshold or discard the data and reanalyse the sample(s).
